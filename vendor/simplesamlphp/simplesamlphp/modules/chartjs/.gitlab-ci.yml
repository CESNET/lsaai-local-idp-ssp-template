variables:
  temporary_branch: "gitlab-ci-package"
  GIT_SSH_COMMAND: "ssh -o StrictHostKeyChecking=no -i /home/gitlab_ci_runner/.ssh/id_rsa"
  GIT_STRATEGY: clone
  GIT_CHECKOUT: "false"

package:
  image: perl:latest
  script:
    - git checkout master
    - rm -rf www && mkdir www && cd www
    - wget https://github.com/chartjs/Chart.js/releases/latest/download/Chart.bundle.min.js
    - wget https://github.com/chartjs/Chart.js/releases/latest/download/Chart.min.css
    - wget https://github.com/chartjs/Chart.js/releases/latest/download/Chart.min.js
    - wget https://github.com/chartjs/chartjs-plugin-zoom/releases/latest/download/chartjs-plugin-zoom.min.js
    - wget https://raw.githubusercontent.com/moment/moment/master/min/locales.min.js
    - wget https://raw.githubusercontent.com/moment/moment/master/min/moment-with-locales.min.js
    - wget https://raw.githubusercontent.com/moment/moment/master/min/moment.min.js
    - wget -O moment.cs.js https://raw.githubusercontent.com/moment/moment/master/locale/cs.js
    - cd ..
    - mkdir -pvm 0700 /home/gitlab_ci_runner/.ssh/
    - echo "$ssh_deploy_key" > /home/gitlab_ci_runner/.ssh/id_rsa
    - chmod 0400 /home/gitlab_ci_runner/.ssh/id_rsa
    - git config --global user.email $(git --no-pager show -s --format='%ae' HEAD)
    - git config --global user.name $(git --no-pager show -s --format='%an' HEAD)
    - git checkout -b "$temporary_branch"
    - git remote set-url --push origin $(perl -pe 's#.*@(.+?(\:\d+)?)/#git@\1:#' <<< $CI_REPOSITORY_URL)
    - git add *
    - git commit -m "Automatic update at revision $CI_COMMIT_SHA [skip ci]" || true
    - git push origin "$temporary_branch:$CI_COMMIT_REF_NAME" || true
  after_script:
    - rm -Rfv /home/gitlab_ci_runner/.ssh/
  artifacts:
    paths:
      - www
  only:
    - master